"0","eventsep
"
"1","function(dailyMQ, monthlyHQ=NULL, dvar=3, gamma=1, theta=0.25, ddur=40,omega=2,
"
"1","  Kappa=0.4, eta=0.1, delta=0.2, usemed=FALSE, medbf=0.5, NA_mode = NULL, Messages=TRUE){
"
"1","
"
"1","  if(is.null(monthlyHQ)){
"
"1","    monthlyHQ <- data.frame(NA,NA)
"
"1","  }else{
"
"1","    stopifnot(any(class(monthlyHQ[[1]]) %in% c(""POSIXct"", ""POSIXt"",""Date"")))
"
"1","  }
"
"1","  monthlyHQ <- as.data.frame(monthlyHQ)
"
"1","
"
"1","  daten<-as.data.frame(dailyMQ[,1:2])
"
"1","  stopifnot(any(class(daten[[1]]) %in% c(""POSIXct"", ""POSIXt"",""Date"")))
"
"1","
"
"1","  if(any(class(daten[[1]]) == ""Date"")){
"
"1","    convol <- 1L
"
"1","  }else{
"
"1","    convol <- 60^2
"
"1","  }
"
"1","
"
"1","  if(!is.null(NA_mode)){
"
"1","    #Interpolate single values
"
"1","    daten_NA <-daten[,2]
"
"1","    daten_NA[!is.na(daten_NA)] <- 0
"
"1","    daten_NA[is.na(daten_NA)] <- 1
"
"1","    rl <- rle(daten_NA)
"
"1","    to_int <- which(rl$lengths <= NA_mode & rl$values==1)
"
"1","    if(length(to_int)>=1){
"
"1","      for(i in 1:length(to_int)){
"
"1","        inds_to_interp <- (sum(rl$lengths[1:(to_int[i]-1)])) : (sum(rl$lengths[1:to_int[i]])+1)
"
"1","        daten[inds_to_interp,2] <- seq(daten[inds_to_interp[1],2], daten[inds_to_interp[length(inds_to_interp)],2],
"
"1","          length.out=length(inds_to_interp))
"
"1","      }
"
"1","    }
"
"1","    if(Messages) cat(""Interpolated"",  length(to_int), ""NA-gaps\n"")
"
"1","
"
"1","    daten_NA <-daten[,2]
"
"1","    daten_NA[!is.na(daten_NA)] <- 0
"
"1","    daten_NA[is.na(daten_NA)] <- 1
"
"1","
"
"1","    spl <- rep(NA, length(daten_NA))
"
"1","    lastNA <- FALSE
"
"1","    cc=1
"
"1","    for(i in 1:length(daten_NA)){
"
"1","      if(daten_NA[i]==0 & lastNA==TRUE){
"
"1","        cc=cc+1
"
"1","        spl[i] <- cc
"
"1","        lastNA <- FALSE
"
"1","      }else if(daten_NA[i]==0 & lastNA==FALSE) {
"
"1","        spl[i] <- cc
"
"1","        lastNA <- FALSE
"
"1","      }else{
"
"1","        spl[i] <- NA
"
"1","        lastNA <- TRUE
"
"1","      }
"
"1","    }
"
"1","    daten_list <- split(daten, spl)
"
"1","    if(length(daten_list)>1){
"
"1","      if(Messages) cat(""Splitted timeseries into"",  length(daten_list), ""parts, but appending results together\n"")
"
"1","    }
"
"1","  }else{
"
"1","    spl <- rep(1, nrow(daten))
"
"1","    if(!identical(unique(diff(daten[,1])), 1)) stop(""Timeseries not continious!\n"")
"
"1","    if(any(is.na(daten[,2]))) stop(""Timeseries does contain NA, but NA_mode is not set!\n"")
"
"1","    daten_list <- list(daten)
"
"1","  }
"
"1","
"
"1","
"
"1","
"
"1","  #calculate the window-variance with window length dvar
"
"1","  data_temp_var3d <- daten
"
"1","  var3d<-rep(0,length(data_temp_var3d[,1]))
"
"1","  for(i in dvar:length(data_temp_var3d[,1])){
"
"1","    var3d[i]<-var(data_temp_var3d[(i-(dvar-1)):i,2],na.rm = TRUE)
"
"1","  }
"
"1","  var3d_list <- split(var3d, spl)
"
"1","
"
"1","  #calculate the theshold for the variance
"
"1","  thvar<-mean(var3d[dvar:length(var3d)], na.rm = TRUE)+theta*sd(var3d[dvar:length(var3d)], na.rm = TRUE)
"
"1","
"
"1","  #Start actual sep
"
"1","  for(list_it in seq_along(daten_list)){
"
"1","    daten <- daten_list[[list_it]]
"
"1","    var3d <- var3d_list[[list_it]]
"
"1","
"
"1","    diffs<-diff(daten[,2], lag=1)
"
"1","    diffs<-c(0,diffs)
"
"1","
"
"1","
"
"1","
"
"1","    #claculate the cumulative Lag 1 differences
"
"1","    if(any(is.na(diffs))){
"
"1","      cumdiffs<-numeric(length(diffs))
"
"1","      cumdiffs[1]<-diffs[1]
"
"1","      for(k in 2:length(diffs)){
"
"1","        if(is.na(diffs[k])){
"
"1","          cumdiffs[k]<-0
"
"1","        }else{
"
"1","          cumdiffs[k]<-cumdiffs[k-1]+diffs[k]
"
"1","        }
"
"1","      }
"
"1","    }else{
"
"1","      cumdiffs<-cumsum(diffs)
"
"1","    }
"
"1","
"
"1","
"
"1","
"
"1","    #start iterating the days until the variance threshold is exceeded
"
"1","    events <- data.frame(NULL)
"
"1","    n2<-0
"
"1","    i<- 10
"
"1","    while(i < length(var3d)){
"
"1","      old_start<-0
"
"1","      i<-i+1
"
"1","      if(!is.na(var3d[i])){
"
"1","        if(var3d[i]>thvar){
"
"1","          var3dpart<-var3d[(i):length(var3d)]
"
"1","          endvar<-min(which(var3dpart<thvar)[1],length(var3dpart), na.rm=TRUE)
"
"1","          peak_ind<-min((i + which.max(var3dpart[1:endvar])-1), (length(var3d)-10))
"
"1","          while(daten[peak_ind-1,2]>daten[peak_ind,2]){
"
"1","            peak_ind<-peak_ind-1
"
"1","          }
"
"1","
"
"1","
"
"1","          #chosse the event start as the days where the lag 1  differences are negative the last time
"
"1","          pos_start<-max(which(diffs[1:(peak_ind-1)]<0),3)
"
"1","
"
"1","          #modify start according to the assumptions
"
"1","          while(((daten[pos_start+1,2]-daten[pos_start,2])<
"
"1","              ((daten[peak_ind,2]-daten[pos_start,2])*eta)) && (pos_start<peak_ind-1)) {
"
"1","            pos_start<-pos_start+1
"
"1","          }
"
"1","
"
"1","          gammaneu<-min(gamma,pos_start-2)
"
"1","          maxstart<-matrix(NA, nrow=gammaneu, ncol=gammaneu+1)
"
"1","          for(z in 1:gammaneu){
"
"1","            for (v in (z+1):(gammaneu+1)){
"
"1","              maxstart[z,v]<-daten[pos_start-z,2]-daten[pos_start-v,2]
"
"1","            }
"
"1","          }
"
"1","
"
"1","          if((max(maxstart, na.rm = TRUE)>((daten[peak_ind,2]-daten[pos_start,2])*Kappa)) &&
"
"1","              (daten[pos_start-2,2]<daten[peak_ind,2])){
"
"1","            pos_start<-max(pos_start-which(maxstart == max(maxstart, na.rm=TRUE), arr.ind = TRUE)[2],3)
"
"1","          }
"
"1","
"
"1","          if(daten[pos_start,2]>daten[pos_start+1,2]) pos_start<-pos_start+1
"
"1","          while(daten[peak_ind,2]<=daten[peak_ind+1,2]&& peak_ind < (length(var3d)-2)){
"
"1","            peak_ind<-peak_ind+1
"
"1","          }
"
"1","
"
"1","          #calculate the sum of the rising limb
"
"1","          incsum<- sum(diffs[(pos_start+1):peak_ind])
"
"1","
"
"1","
"
"1","
"
"1","          #define the end of the event
"
"1","          pos_end<-peak_ind+1
"
"1","
"
"1","
"
"1","          basefl1<-approxfun(c(daten[pos_start,1],daten[pos_end,1]),c(daten[pos_start,2],daten[pos_end,2]))
"
"1","          base_diff<-(basefl1(daten[pos_start:pos_end,1])-daten[pos_start:pos_end,2])
"
"1","          base_rel<-(basefl1(daten[pos_end,1])-basefl1(daten[pos_start,1]))/(pos_end-pos_start)
"
"1","
"
"1","
"
"1","          #use median baseflow difference?
"
"1","          if(usemed){
"
"1","            while((((((sum(diffs[(peak_ind+1):(pos_end+omega)], na.rm = TRUE)-sum(diffs[(peak_ind+1):(pos_end)], na.rm = TRUE))/
"
"1","                sum(diffs[(peak_ind+1):(pos_end)], na.rm = TRUE))>(1+delta))||
"
"1","                any(base_diff>0) || (base_rel>(2*medbf)) ||
"
"1","                ((incsum+sum(diffs[(peak_ind+1):pos_end], na.rm = TRUE))>(1*daten[pos_start,2]))))){
"
"1","
"
"1","              if(is.na(cumdiffs[pos_end+1])){break}
"
"1","              pos_end<-pos_end+1
"
"1","
"
"1","              basefl1<-approxfun(c(daten[pos_start,1],daten[pos_end,1]),c(daten[pos_start,2],daten[pos_end,2]))
"
"1","              base_diff<-(basefl1(daten[pos_start:pos_end,1])-daten[pos_start:pos_end,2])
"
"1","              base_rel<-(basefl1(daten[pos_end,1])-basefl1(daten[pos_start,1]))/(pos_end-pos_start)
"
"1","            }
"
"1","          }else{
"
"1","            while((((((sum(diffs[(peak_ind+1):(pos_end+omega)], na.rm = TRUE)-sum(diffs[(peak_ind+1):(pos_end)], na.rm = TRUE))/
"
"1","                sum(diffs[(peak_ind+1):(pos_end)], na.rm = TRUE))>(1+delta))||
"
"1","                any(base_diff>0)  ||
"
"1","                ((incsum+sum(diffs[(peak_ind+1):pos_end], na.rm = TRUE))>(1*daten[pos_start,2])))) ){
"
"1","              if(is.na(cumdiffs[pos_end+1])){break}
"
"1","              pos_end<-pos_end+1
"
"1","
"
"1","              basefl1<-approxfun(c(daten[pos_start,1],daten[pos_end,1]),c(daten[pos_start,2],daten[pos_end,2]))
"
"1","              base_diff<-(basefl1(daten[pos_start:pos_end,1])-daten[pos_start:pos_end,2])
"
"1","              base_rel<-(basefl1(daten[pos_end,1])-basefl1(daten[pos_start,1]))/(pos_end-pos_start)
"
"1","            }
"
"1","          }
"
"1","
"
"1","          if(pos_end<length(daten[,1])) pos_end<-pos_end+1
"
"1","
"
"1","          if(daten[pos_end,2]>=daten[pos_end-1,2]) pos_end<-pos_end-1
"
"1","
"
"1","          while(daten[pos_end,2]<daten[pos_start,2]) pos_end<-pos_end-1
"
"1","
"
"1","
"
"1","          No_peaks_all<-sum(diff(sign(diff(daten[pos_start:pos_end,2]))) < -1)
"
"1","
"
"1","          no_max<-diff(sign(diff(var3d[pos_start:pos_end])))
"
"1","          no_peaks<-max(1,sum((no_max< -1) & (var3d[(pos_start+1):(pos_end-1)]>thvar) &
"
"1","              (diff(sign(diff(daten[pos_start:pos_end,2])))< -1)))
"
"1","
"
"1","          peak_ind<-which.max(daten[pos_start:pos_end,2])+pos_start-1
"
"1","
"
"1","
"
"1","          #create output for event
"
"1","          if(!((peak_ind == pos_start) || (No_peaks_all==0) || (ncol(events)>=3 && daten[peak_ind,1] %in% events[[3]]))){
"
"1","
"
"1","            basefl<-approxfun(c(daten[pos_start,1],daten[pos_end,1]),c(daten[pos_start,2],daten[pos_end,2]))
"
"1","            start<-daten[pos_start,1]
"
"1","            end<-daten[pos_end,1]
"
"1","            peak_MQ<-max(daten[(pos_start):(pos_end),2])
"
"1","            peak_date<-daten[peak_ind,1]
"
"1","            Volume<-sum(daten[(pos_start):(pos_end),2])*24*60*60/1000000
"
"1","            Baseflow_peak<-basefl(peak_date)
"
"1","            Base_vol<-integrate(basefl, lower=daten[pos_start,1], upper=daten[pos_end,1])$value*24*60*60/1000000
"
"1","            Vol_dir<-Volume-Base_vol
"
"1","            base_start<-basefl(start)
"
"1","            base_end<-basefl(end)
"
"1","            HQ<-monthlyHQ[which((monthlyHQ[,1]>=(peak_date-1)) & (monthlyHQ[,1]<=(peak_date+1))),2 ]
"
"1","            if(length(HQ)<1){HQ<-NA}else{HQ<-max(HQ)}
"
"1","            if(!is.na(HQ) && (HQ<peak_MQ)){HQ<-NA}
"
"1","            HQ_dir<-HQ-Baseflow_peak
"
"1","            comm<-"" ""
"
"1","
"
"1","            if(any(end<events$End)) comm<-""aufgesetzt""
"
"1","
"
"1","            event_temp <- data.frame(start, end, peak_date,peak_MQ, Volume, Vol_dir, Baseflow_peak,base_start,base_end,no_peaks,HQ, HQ_dir, comm)
"
"1","            names(event_temp) <- c(""Begin"", ""End"", ""Peak_date"", ""DailyMQ"", ""Volume"", ""dir_Volume"",
"
"1","              ""baseflow_peak"",""baseflow_begin"",""baseflow_end"", ""No_Peaks"", ""HQ"", ""HQ_dir"", ""Comments"")
"
"1","            events<-rbind(events, event_temp)
"
"1","          }
"
"1","
"
"1","          #multiple peak event?
"
"1","          # if(No_peaks_all>=400) browser()
"
"1","
"
"1","          if(No_peaks_all>1){
"
"1","
"
"1","            #possible double-peaked event
"
"1","            if((pos_end-pos_start+1)<ddur){
"
"1","              peaks<-pos_start+which(diff(sign(diffs[pos_start:pos_end]) ) < -1)-1
"
"1","
"
"1","              old_start<-pos_start
"
"1","              old_end<-pos_end
"
"1","
"
"1","              maxis<-mapply(function(x,y){max(daten[x,2],daten[y,2])},x=peaks[1:(length(peaks)-1)],y=peaks[2:length(peaks)])
"
"1","              minmax<-mapply(function(x,y){min(daten[x,2],daten[y,2])},x=peaks[1:(length(peaks)-1)],y=peaks[2:length(peaks)])
"
"1","
"
"1","              minis<-mapply(function(x,y){min(daten[x:y,2])},x=peaks[1:(length(peaks)-1)],y=peaks[2:length(peaks)])
"
"1","
"
"1","              #test the condition for double-peaked events
"
"1","              if(any(((0.4*maxis)>= minis) & ((maxis*0.2)<=minmax) & (minis <= (0.7*minmax)))){ ####Fall?berlagerung
"
"1","
"
"1","                max_diff<-minmax-minis
"
"1","
"
"1","                ind_diff<-which(((0.4*maxis)>= minis) & ((maxis*0.2)<=minmax) & (minis <= (0.7*minmax)))
"
"1","
"
"1","                ind2<-which.max(max_diff[ind_diff])
"
"1","
"
"1","                peak_ind<-peaks[ind_diff[ind2]]
"
"1","
"
"1","                pos_start<-old_start
"
"1","
"
"1","                pos_end<-which.min(daten[peak_ind:peaks[ind_diff[ind2]+1],2])+peak_ind-1
"
"1","
"
"1","                ##construct first wave
"
"1","                wave<-daten[pos_start:pos_end,]
"
"1","
"
"1","                n1<-length(wave[,1])
"
"1","                n_save<-n1
"
"1","
"
"1","                while(daten[old_end,2]<wave[n1,2]){
"
"1","
"
"1","                  next_ind<-which(daten[(pos_start+n1+1):old_end,2]< wave[n1,2])[1]+pos_start+n1 ##positiv!!!
"
"1","
"
"1","                  wave<-rbind(wave, daten[next_ind,])
"
"1","
"
"1","                  n1<-length(wave[,1])
"
"1","
"
"1","                }
"
"1","
"
"1","                no_max<-diff(sign(diff(var3d[old_start:(old_start+n1-1)])))
"
"1","                no_peaks<-max(1,sum((no_max< -1) & (var3d[(old_start+1):(old_start+n1-2)]>thvar) & (diff(sign(diff(daten[old_start:(old_start+n1-1),2])))< -1)))
"
"1","
"
"1","                peak_ind<-which.max(wave[,2])
"
"1","                #characteristics of first wave
"
"1","                if((peak_ind != 1)){
"
"1","                  basefl<-approxfun(c(1,n1),c(wave[1,2],wave[n1,2]))
"
"1","                  start<-wave[1,1]
"
"1","                  end<-start+((n1-1)*convol)
"
"1","                  peak_MQ<-max(wave[,2])
"
"1","                  peak_date<-wave[peak_ind,1]
"
"1","                  Volume<-sum(wave[,2])*24*60*60/1000000
"
"1","                  Baseflow_peak<-basefl(peak_ind)
"
"1","                  Base_vol<-integrate(basefl, lower=1, upper=n1)$value*24*60*60/1000000
"
"1","                  Vol_dir<-Volume-Base_vol
"
"1","                  base_start<-basefl(1)
"
"1","                  base_end<-basefl(n1)
"
"1","                  HQ<-monthlyHQ[which((monthlyHQ[,1]>=(peak_date-1)) & (monthlyHQ[,1]<=(peak_date+1))),2 ]
"
"1","                  if(length(HQ)<1){HQ<-NA}else{HQ<-max(HQ)}
"
"1","                  if(!is.na(HQ) && (HQ<peak_MQ)){HQ<-NA}
"
"1","                  HQ_dir<-HQ-Baseflow_peak
"
"1","                  comm<-""first wave""
"
"1","
"
"1","                  event_temp <- data.frame(start, end, peak_date,peak_MQ, Volume, Vol_dir, Baseflow_peak,base_start,base_end,no_peaks,HQ, HQ_dir, comm)
"
"1","                  names(event_temp) <- c(""Begin"", ""End"", ""Peak_date"", ""DailyMQ"", ""Volume"", ""dir_Volume"",
"
"1","                    ""baseflow_peak"",""baseflow_begin"",""baseflow_end"", ""No_Peaks"", ""HQ"", ""HQ_dir"", ""Comments"")
"
"1","                  events<-rbind(events, event_temp)
"
"1","                }
"
"1","
"
"1","
"
"1","                # construct second wave
"
"1","                sec_wave<-daten[pos_end:old_end,]
"
"1","                sec_wave[1:(n1-n_save+1),2]<-sec_wave[1:(n1-n_save+1),2]-wave[(n_save):n1,2]
"
"1","
"
"1","                n2<-length(sec_wave[,2])
"
"1","
"
"1","                no_max<-diff(sign(diff(var3d[(old_start+n1-1):old_end])))
"
"1","                no_peaks<-max(1,sum((no_max< -1) & (var3d[(old_start+n1):(old_end-1)]>thvar) & (diff(sign(diff(daten[(old_start+n1-1):old_end,2])))< -1)))
"
"1","
"
"1","
"
"1","                peak_ind<-which.max(daten[pos_end:old_end,2])
"
"1","
"
"1","                #characteristics of second wave
"
"1","                if(peak_ind != 1){
"
"1","                  basefl<-approxfun(c(1,n2),c(sec_wave[1,2],sec_wave[n2,2]))
"
"1","                  start<-sec_wave[1,1]
"
"1","                  end<-start+((n2-1)*convol)
"
"1","                  peak_MQ<-max(sec_wave[,2])
"
"1","                  peak_date<-sec_wave[peak_ind,1]
"
"1","                  Volume<-sum(sec_wave[,2])*24*60*60/1000000
"
"1","                  Baseflow_peak<-basefl(peak_ind)
"
"1","                  Base_vol<-integrate(basefl, lower=1, upper=n2)$value*24*60*60/1000000
"
"1","                  Vol_dir<-Volume-Base_vol
"
"1","                  base_start<-basefl(1)
"
"1","                  base_end<-basefl(n2)
"
"1","                  HQ<-monthlyHQ[which((monthlyHQ[,1]>=(peak_date-1)) & (monthlyHQ[,1]<=(peak_date+1))),2 ]
"
"1","                  if(length(HQ)<1){HQ<-NA}else{HQ<-max(HQ)}
"
"1","                  if(!is.na(HQ) && (HQ<peak_MQ)){HQ<-NA}
"
"1","                  HQ_dir<-HQ-Baseflow_peak
"
"1","                  comm<-""second wave""
"
"1","
"
"1","                  event_temp <- data.frame(start, end, peak_date,peak_MQ, Volume, Vol_dir, Baseflow_peak,base_start,base_end,no_peaks,HQ, HQ_dir, comm)
"
"1","                  names(event_temp) <- c(""Begin"", ""End"", ""Peak_date"", ""DailyMQ"", ""Volume"", ""dir_Volume"",
"
"1","                    ""baseflow_peak"",""baseflow_begin"",""baseflow_end"", ""No_Peaks"", ""HQ"", ""HQ_dir"", ""Comments"")
"
"1","                  events<-rbind(events, event_temp)
"
"1","
"
"1","                }
"
"1","              }
"
"1","
"
"1","
"
"1","              #possible overlaid event
"
"1","            }else{
"
"1","              peaks<-pos_start+which(diff(sign(diffs[pos_start:pos_end])) < -1)-1
"
"1","              real_peaks<-peaks[daten[peaks,2]>=(max(daten[peaks,2])*0.2)]
"
"1","              old_start<-pos_start
"
"1","              old_end<-pos_end
"
"1","
"
"1","              #check the assumptions on overlaid events
"
"1","              if(any(diff(daten[real_peaks,1])>7)){
"
"1","                ind_ev<-match(real_peaks[which(diff(daten[real_peaks,1])>7)], peaks)
"
"1","
"
"1","
"
"1","                #split the overlaid waves from the main event
"
"1","                for(j in 1:length(ind_ev)){
"
"1","                  if((0.5*max(daten[peaks[ind_ev[j]],2],daten[peaks[ind_ev[j]+1],2]))>= min(daten[peaks[ind_ev[j]]:(peaks[ind_ev[j]+1]),2])){
"
"1","
"
"1","                    pos_end<-peaks[ind_ev[j]]+1
"
"1","
"
"1","                    while(diffs[pos_end]<=0){
"
"1","                      if(is.na(diffs[pos_end])){break}
"
"1","                      pos_end<-pos_end+1
"
"1","
"
"1","                    }
"
"1","
"
"1","
"
"1","                    if(daten[pos_end,2]>daten[pos_end-1,2]){pos_end<-pos_end-1}
"
"1","                    peak_ind<-max(peaks[max(ind_ev[j-1]+1,1)])
"
"1","
"
"1","                    pos_start<-peak_ind-1
"
"1","                    while(diffs[pos_start]>=0){
"
"1","                      if(is.na(diffs[pos_start])){break}
"
"1","                      pos_start<-pos_start-1
"
"1","
"
"1","                    }
"
"1","                    while(daten[pos_start,2]<daten[pos_end,2]){
"
"1","                      pos_start<-pos_start+1
"
"1","
"
"1","                    }
"
"1","                    pos_start<-pos_start-1
"
"1","
"
"1","                    if(daten[pos_start,2]>=daten[pos_start+1,2]){pos_start<-pos_start+1}
"
"1","
"
"1","                    if(any(daten[(pos_start+1):peaks[ind_ev[j]],2]<daten[pos_start,2])){
"
"1","                      pos_start<-max(which(daten[(pos_start+1):peaks[ind_ev[j]],2]==min(daten[(pos_start+1):peaks[ind_ev[j]],2])))+pos_start
"
"1","                    }
"
"1","
"
"1","
"
"1","                    no_max<-diff(sign(diff(var3d[pos_start:pos_end])))
"
"1","                    no_peaks<-max(1,sum((no_max< -1) & (var3d[(pos_start+1):(pos_end-1)]>thvar) & (diff(sign(diff(daten[pos_start:pos_end,2])))< -1)))
"
"1","
"
"1","
"
"1","                    peak_ind<-which.max(daten[pos_start:pos_end,2])+pos_start-1
"
"1","
"
"1","                    if(peak_ind != pos_start){
"
"1","                      basefl<-approxfun(c(daten[pos_start,1],daten[pos_end,1]),c(daten[pos_start,2],daten[pos_end,2]))
"
"1","                      start<-daten[pos_start,1]
"
"1","                      end<-daten[pos_end,1]
"
"1","                      peak_MQ<-max(daten[(pos_start):(pos_end),2])
"
"1","                      peak_date<-daten[peak_ind,1]
"
"1","                      Volume<-sum(daten[(pos_start):(pos_end),2])*24*60*60/1000000
"
"1","                      Baseflow_peak<-basefl(peak_date)
"
"1","                      Base_vol<-integrate(basefl, lower=daten[pos_start,1], upper=daten[pos_end,1])$value*24*60*60/1000000
"
"1","                      Vol_dir<-Volume-Base_vol
"
"1","                      base_start<-basefl(start)
"
"1","                      base_end<-basefl(end)
"
"1","                      HQ<-monthlyHQ[which((monthlyHQ[,1]>=(peak_date-1)) & (monthlyHQ[,1]<=(peak_date+1))),2 ]
"
"1","                      if(length(HQ)<1){HQ<-NA}else{HQ<-max(HQ)}
"
"1","                      if(!is.na(HQ) && (HQ<peak_MQ)){HQ<-NA}
"
"1","                      HQ_dir<-HQ-Baseflow_peak
"
"1","                      comm<-""overlaid""
"
"1","
"
"1","                      event_temp <- data.frame(start, end, peak_date,peak_MQ, Volume, Vol_dir, Baseflow_peak,base_start,base_end,no_peaks,HQ, HQ_dir, comm)
"
"1","                      names(event_temp) <- c(""Begin"", ""End"", ""Peak_date"", ""DailyMQ"", ""Volume"", ""dir_Volume"",
"
"1","                        ""baseflow_peak"",""baseflow_begin"",""baseflow_end"", ""No_Peaks"", ""HQ"", ""HQ_dir"", ""Comments"")
"
"1","                      events<-rbind(events, event_temp)
"
"1","                    }
"
"1","                  }
"
"1","                }
"
"1","
"
"1","                #remaining part of overlaid wave
"
"1","                if(any((peaks> pos_end) & (peaks>(peak_ind+7)) & (daten[peaks,2]>0.2*max(daten[peaks,2])))){
"
"1","                  peak_ind<-which((peaks> pos_end) & (peaks>(peak_ind+7)) & (daten[peaks,2]>0.2*max(daten[peaks,2])))
"
"1","                  peak_ind<-peaks[peak_ind[which.max(daten[peak_ind,2])]]
"
"1","
"
"1","                  pos_end<-peaks[length(peaks)]+1
"
"1","
"
"1","                  while(diffs[pos_end]<=0){
"
"1","                    if(is.na(diffs[pos_end+1])) break
"
"1","                    pos_end<-pos_end+1
"
"1","                  }
"
"1","
"
"1","                  if(daten[pos_end,2]>daten[pos_end-1,2])pos_end<-pos_end-1
"
"1","                  if(pos_end>old_end)pos_end<-old_end
"
"1","
"
"1","                  pos_start<-peaks[ind_ev[length(ind_ev)]+1]
"
"1","                  while(diffs[pos_start]>=0){
"
"1","                    if(is.na(diffs[pos_start])){break}
"
"1","                    pos_start<-pos_start-1
"
"1","
"
"1","                  }
"
"1","                  while(daten[pos_start,2]<daten[pos_end,2]) pos_start<-pos_start+1
"
"1","
"
"1","                  pos_start<-pos_start-1
"
"1","
"
"1","                  if(daten[pos_start,2]>=daten[pos_start+1,2]) pos_start<-pos_start+1
"
"1","
"
"1","                  if(any(daten[(pos_start+1):(which.max(daten[pos_start:pos_end,2])+pos_start-1),2]<daten[pos_start,2])){
"
"1","                    pos_start<-max(which(daten[(pos_start+1):(which.max(daten[pos_start:pos_end,2])+pos_start-1),2]==
"
"1","                        min(daten[(pos_start+1):(which.max(daten[pos_start:pos_end,2])+pos_start-1),2])))+pos_start
"
"1","                  }
"
"1","
"
"1","
"
"1","                  no_max<-diff(sign(diff(var3d[pos_start:pos_end])))
"
"1","                  no_peaks<-max(1,sum((no_max< -1) & (var3d[(pos_start+1):(pos_end-1)]>thvar) & (diff(sign(diff(daten[pos_start:pos_end,2])))< -1)))
"
"1","
"
"1","
"
"1","                  peak_ind<-which.max(daten[pos_start:pos_end,2])+pos_start-1
"
"1","
"
"1","                  if((peak_ind != pos_start)){
"
"1","                    basefl<-approxfun(c(daten[pos_start,1],daten[pos_end,1]),c(daten[pos_start,2],daten[pos_end,2]))
"
"1","                    start<-daten[pos_start,1]
"
"1","                    end<-daten[pos_end,1]
"
"1","                    peak_MQ<-max(daten[(pos_start):(pos_end),2])
"
"1","                    peak_date<-daten[peak_ind,1]
"
"1","                    Volume<-sum(daten[(pos_start):(pos_end),2])*24*60*60/1000000
"
"1","                    Baseflow_peak<-basefl(peak_date)
"
"1","                    Base_vol<-integrate(basefl, lower=daten[pos_start,1], upper=daten[pos_end,1])$value*24*60*60/1000000
"
"1","                    Vol_dir<-Volume-Base_vol
"
"1","                    base_start<-basefl(start)
"
"1","                    base_end<-basefl(end)
"
"1","                    HQ<-monthlyHQ[which((monthlyHQ[,1]>=(peak_date-1)) & (monthlyHQ[,1]<=(peak_date+1))),2 ]
"
"1","                    if(length(HQ)<1){HQ<-NA}else{HQ<-max(HQ)}
"
"1","                    if(!is.na(HQ) && (HQ<peak_MQ)){HQ<-NA}
"
"1","                    HQ_dir<-HQ-Baseflow_peak
"
"1","                    comm<-""overlaid""
"
"1","
"
"1","                    event_temp <- data.frame(start, end, peak_date,peak_MQ, Volume, Vol_dir, Baseflow_peak,base_start,base_end,no_peaks,HQ, HQ_dir, comm)
"
"1","                    names(event_temp) <- c(""Begin"", ""End"", ""Peak_date"", ""DailyMQ"", ""Volume"", ""dir_Volume"",
"
"1","                      ""baseflow_peak"",""baseflow_begin"",""baseflow_end"", ""No_Peaks"", ""HQ"", ""HQ_dir"", ""Comments"")
"
"1","                    t<-rbind(events, event_temp)
"
"1","
"
"1","                  }
"
"1","                }
"
"1","              }
"
"1","            }
"
"1","          }
"
"1","
"
"1","          i<-max(pos_end, i+endvar, old_start+n2-1)
"
"1","
"
"1","        }
"
"1","      }
"
"1","    }
"
"1","
"
"1","    if(list_it==1){
"
"1","      events_all <- events
"
"1","    }else{
"
"1","      events_all <- rbind(events_all,events)
"
"1","    }
"
"1","  }
"
"1","
"
"1","  return(events_all)
"
"1","}
"
"1","<bytecode: 0x000001436ae7db50>
"
"1","<environment: namespace:FloodR>
"
